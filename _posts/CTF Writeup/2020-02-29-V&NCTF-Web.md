---
layout: post
title: V&N Web Writeup
data: 2020-0229
categories: Writeups
tags: 
 - CTF
 - Writeup
description:
---

# HappyCTFd

## 题目描述

访问到的是一个类似于BUUCTF的题库。注册后登录，有一个用户列表，可以看到一个admin用户，然后可以查看每个人的解题记录，不过都是"No solves yet"。

然后可以修改密码和一些其它信息。注意到有一个叫做"Access Tokens"的功能，可以申请API Key，不是很了解。

****

# CHECKIN

## 题目描述

直接给出了源码：

```python
from flask import Flask, request
import os
app = Flask(__name__)

flag_file = open("flag.txt", "r")
# flag = flag_file.read()
# flag_file.close()
#
# @app.route('/flag')
# def flag():
#     return flag
## want flag? naive!

# You will never find the thing you want:) I think
@app.route('/shell')
def shell():
    os.system("rm -f flag.txt")
    exec_cmd = request.args.get('c')
    os.system(exec_cmd)
    return "1"

@app.route('/')
def source():
    return open("app.py","r").read()

if __name__ == "__main__":
    app.run(host='0.0.0.0')

```

## 解题思路

看着就是要利用shell读文件，但是访问shell的时候会将flag文件删除。注意到虽然文件利用rm命令删除了，但是程序本身打开的文件流还没有关闭。

思路是这样的，先获取当前程序的进程号，和文件的文件描述符，然后访问

```bash
/proc/<进程号>/fd/<文件描述符>
```

就可以获得原文件的内容。内容可以ping到DNS上。

一番操作发现几个有用的命令都被禁掉了：

```bash
lsof、ps、grep
```

顶不住了。

****

# TimeTravel

## 题目描述

直接给了源码：

```php
<?php
error_reporting(0);
require __DIR__ . '/vendor/autoload.php';

use GuzzleHttp\Client;

highlight_file(__FILE__);

if(isset($_GET['flag'])) {
    $client = new Client();
    $response = $client->get('http://127.0.0.1:5000/api/eligible');
    $content = $response->getBody();
    $data = json_decode($content, TRUE);
    if($data['success'] === true) {
      echo system('/readflag');
    }
}

if(isset($_GET['file'])) {
    highlight_file($_GET['file']);
}

if(isset($_GET['phpinfo'])) {
    phpinfo();
}
```

读autoload.php：

```php
<?php

// autoload.php @generated by Composer

require_once __DIR__ . '/composer/autoload_real.php';

return ComposerAutoloaderInit52ffee59545490028d211df73b41c57d::getLoader();
```

再读：

```php
<?php

// autoload_real.php @generated by Composer

class ComposerAutoloaderInit52ffee59545490028d211df73b41c57d
{
    private static $loader;

    public static function loadClassLoader($class)
    {
        if ('Composer\Autoload\ClassLoader' === $class) {
            require __DIR__ . '/ClassLoader.php';
        }
    }

    public static function getLoader()
    {
        if (null !== self::$loader) {
            return self::$loader;
        }

        spl_autoload_register(array('ComposerAutoloaderInit52ffee59545490028d211df73b41c57d', 'loadClassLoader'), true, true);
        self::$loader = $loader = new \Composer\Autoload\ClassLoader();
        spl_autoload_unregister(array('ComposerAutoloaderInit52ffee59545490028d211df73b41c57d', 'loadClassLoader'));

        $useStaticLoader = PHP_VERSION_ID >= 50600 && !defined('HHVM_VERSION') && (!function_exists('zend_loader_file_encoded') || !zend_loader_file_encoded());
        if ($useStaticLoader) {
            require_once __DIR__ . '/autoload_static.php';

            call_user_func(\Composer\Autoload\ComposerStaticInit52ffee59545490028d211df73b41c57d::getInitializer($loader));
        } else {
            $map = require __DIR__ . '/autoload_namespaces.php';
            foreach ($map as $namespace => $path) {
                $loader->set($namespace, $path);
            }

            $map = require __DIR__ . '/autoload_psr4.php';
            foreach ($map as $namespace => $path) {
                $loader->setPsr4($namespace, $path);
            }

            $classMap = require __DIR__ . '/autoload_classmap.php';
            if ($classMap) {
                $loader->addClassMap($classMap);
            }
        }

        $loader->register(true);

        if ($useStaticLoader) {
            $includeFiles = Composer\Autoload\ComposerStaticInit52ffee59545490028d211df73b41c57d::$files;
        } else {
            $includeFiles = require __DIR__ . '/autoload_files.php';
        }
        foreach ($includeFiles as $fileIdentifier => $file) {
            composerRequire52ffee59545490028d211df73b41c57d($fileIdentifier, $file);
        }

        return $loader;
    }
}

function composerRequire52ffee59545490028d211df73b41c57d($fileIdentifier, $file)
{
    if (empty($GLOBALS['__composer_autoload_files'][$fileIdentifier])) {
        require $file;

        $GLOBALS['__composer_autoload_files'][$fileIdentifier] = true;
    }
}
```

